(()=>{"use strict";var e={56:(e,n,t)=>{e.exports=function(e){var n=t.nc;n&&e.setAttribute("nonce",n)}},72:e=>{var n=[];function t(e){for(var t=-1,r=0;r<n.length;r++)if(n[r].identifier===e){t=r;break}return t}function r(e,r){for(var o={},a=[],s=0;s<e.length;s++){var l=e[s],c=r.base?l[0]+r.base:l[0],d=o[c]||0,u="".concat(c," ").concat(d);o[c]=d+1;var m=t(u),h={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==m)n[m].references++,n[m].updater(h);else{var p=i(h,r);r.byIndex=s,n.splice(s,0,{identifier:u,updater:p,references:1})}a.push(u)}return a}function i(e,n){var t=n.domAPI(n);return t.update(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap&&n.supports===e.supports&&n.layer===e.layer)return;t.update(e=n)}else t.remove()}}e.exports=function(e,i){var o=r(e=e||[],i=i||{});return function(e){e=e||[];for(var a=0;a<o.length;a++){var s=t(o[a]);n[s].references--}for(var l=r(e,i),c=0;c<o.length;c++){var d=t(o[c]);0===n[d].references&&(n[d].updater(),n.splice(d,1))}o=l}}},113:e=>{e.exports=function(e,n){if(n.styleSheet)n.styleSheet.cssText=e;else{for(;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(document.createTextNode(e))}}},249:(e,n,t)=>{t.d(n,{A:()=>s});var r=t(601),i=t.n(r),o=t(314),a=t.n(o)()(i());a.push([e.id,"@import url(https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap);"]),a.push([e.id,':root {\n  --primary-color: #3498db;\n  --secondary-color: #2980b9;\n  --accent-color: #e67e22;\n  --bg-color: #f9f9f9;\n  --text-color: #333;\n  --light-gray: #ecf0f1;\n  --dark-gray: #7f8c8d;\n  --success-color: #2ecc71;\n  --error-color: #e74c3c;\n  --border-radius: 8px;\n  --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n}\n\n* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: "Poppins", sans-serif;\n  background-color: var(--bg-color);\n  color: var(--text-color);\n  line-height: 1.6;\n}\n\n.container {\n  width: 100%;\n  max-width: 1200px;\n  margin: 0 auto;\n  padding: 0 1rem;\n}\n\n/* Skip to content link for accessibility */\n.skip-link {\n  position: absolute;\n  top: -40px;\n  left: 0;\n  background-color: var(--primary-color);\n  color: white;\n  padding: 8px 16px;\n  z-index: 100;\n  transition: top 0.3s;\n  text-decoration: none;\n}\n\n.skip-link:focus {\n  top: 0;\n}\n\n/* Screen reader only class */\n.sr-only {\n  position: absolute;\n  width: 1px;\n  height: 1px;\n  padding: 0;\n  margin: -1px;\n  overflow: hidden;\n  clip: rect(0, 0, 0, 0);\n  white-space: nowrap;\n  border-width: 0;\n}\n\na {\n  color: var(--primary-color);\n  text-decoration: none;\n  transition: all 0.3s ease;\n}\n\na:hover {\n  color: var(--secondary-color);\n}\n\nimg {\n  max-width: 100%;\n  height: auto;\n}\n\n/* Focus styling for better accessibility */\n:focus {\n  outline: 2px solid var(--primary-color);\n  outline-offset: 2px;\n}\n\n/* Header styles */\n.app-header {\n  background-color: var(--primary-color);\n  color: white;\n  padding: 1rem 0;\n  box-shadow: var(--box-shadow);\n  position: sticky;\n  top: 0;\n  z-index: 10;\n}\n\n.app-header .container {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n}\n\n.app-header h1 {\n  font-size: 1.5rem;\n  margin: 0;\n}\n\n.main-nav ul {\n  display: flex;\n  list-style: none;\n  gap: 1rem;\n}\n\n.main-nav a,\n.btn-link {\n  color: white;\n  padding: 0.5rem 1rem;\n  border-radius: var(--border-radius);\n  transition: background-color 0.3s ease;\n  min-height: 44px;\n  min-width: 44px;\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  text-decoration: none;\n}\n\n.main-nav a:hover,\n.btn-link:hover {\n  background-color: var(--secondary-color);\n}\n\n.btn-link {\n  background: none;\n  border: none;\n  cursor: pointer;\n  font-family: inherit;\n  font-size: inherit;\n}\n\n/* Main content styles */\n.app-content {\n  min-height: calc(100vh - 130px);\n  padding: 2rem 0;\n}\n\n/* Footer styles */\n.app-footer {\n  background-color: var(--text-color);\n  color: white;\n  padding: 1rem 0;\n  text-align: center;\n}\n\n/* Story card styles */\n.story-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));\n  gap: 1.5rem;\n  margin-top: 1.5rem;\n}\n\n.story-card {\n  background-color: white;\n  border-radius: var(--border-radius);\n  overflow: hidden;\n  box-shadow: var(--box-shadow);\n  transition: transform 0.3s ease;\n}\n\n.story-card:hover {\n  transform: translateY(-5px);\n}\n\n.story-image {\n  height: 200px;\n  width: 100%;\n  object-fit: cover;\n}\n\n.story-content {\n  padding: 1rem;\n}\n\n.story-title {\n  font-size: 1.2rem;\n  margin-bottom: 0.5rem;\n  color: var(--text-color);\n}\n\n.story-description {\n  color: var(--text-color);\n  margin-bottom: 1rem;\n  display: -webkit-box;\n  -webkit-box-orient: vertical;\n  -webkit-line-clamp: 3;\n  overflow: hidden;\n}\n\n.story-meta {\n  display: flex;\n  justify-content: space-between;\n  color: var(--text-color);\n  font-size: 0.85rem;\n  margin-bottom: 1rem;\n}\n\n/* Form elements */\n.form-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n  gap: 2rem;\n}\n\n.form-group {\n  margin-bottom: 1.5rem;\n}\n\n.form-label {\n  display: block;\n  margin-bottom: 0.5rem;\n  font-weight: 500;\n}\n\n.form-control {\n  width: 100%;\n  padding: 0.75rem;\n  border: 1px solid var(--light-gray);\n  border-radius: var(--border-radius);\n  font-family: inherit;\n  font-size: 1rem;\n  transition: border-color 0.3s ease;\n}\n\n.form-control:focus {\n  outline: none;\n  border-color: var(--primary-color);\n}\n\ntextarea.form-control {\n  min-height: 120px;\n  resize: vertical;\n}\n\n.form-text {\n  font-size: 0.875rem;\n  color: var(--dark-gray);\n  margin-top: 0.25rem;\n}\n\n/* Map container */\n.map-container {\n  height: 300px;\n  width: 100%;\n  border-radius: var(--border-radius);\n  overflow: hidden;\n  margin: 1.5rem 0;\n}\n\n/* Buttons */\n.btn {\n  display: inline-block;\n  padding: 0.75rem 1.5rem;\n  background-color: var(--primary-color);\n  color: white;\n  border: none;\n  border-radius: var(--border-radius);\n  font-family: inherit;\n  font-size: 1rem;\n  cursor: pointer;\n  transition: background-color 0.3s ease;\n  min-height: 44px;\n  min-width: 44px;\n  text-decoration: none;\n  margin: 0.25rem;\n}\n\n.btn:hover {\n  background-color: var(--secondary-color);\n}\n\n.btn-block {\n  display: block;\n  width: 100%;\n}\n\n.btn-danger {\n  background-color: var(--error-color);\n}\n\n.btn-danger:hover {\n  background-color: #c0392b;\n}\n\n.btn:disabled {\n  background-color: var(--dark-gray);\n  cursor: not-allowed;\n}\n\n/* Alerts */\n.alert {\n  padding: 1rem;\n  margin-bottom: 1rem;\n  border-radius: var(--border-radius);\n}\n\n.alert-success {\n  background-color: rgba(46, 204, 113, 0.1);\n  border: 1px solid var(--success-color);\n  color: var(--success-color);\n}\n\n.alert-error {\n  background-color: rgba(231, 76, 60, 0.1);\n  border: 1px solid var(--error-color);\n  color: var(--error-color);\n}\n\n/* Camera elements */\n.camera-container {\n  position: relative;\n  width: 100%;\n  height: 300px;\n  border-radius: var(--border-radius);\n  overflow: hidden;\n  background-color: var(--light-gray);\n}\n\n.camera-preview {\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n}\n\n.camera-controls {\n  position: absolute;\n  bottom: 1rem;\n  left: 0;\n  right: 0;\n  display: flex;\n  justify-content: center;\n  gap: 1rem;\n}\n\n.camera-btn {\n  background-color: white;\n  color: var(--text-color);\n  width: 50px;\n  height: 50px;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  cursor: pointer;\n  transition: all 0.3s ease;\n  border: none;\n}\n\n.camera-btn:hover {\n  background-color: var(--light-gray);\n}\n\n/* Section titles */\n.section-title {\n  font-size: 2rem;\n  margin-bottom: 1rem;\n  color: var(--text-color);\n}\n\n.section-description {\n  font-size: 1.1rem;\n  color: var(--dark-gray);\n  margin-bottom: 1.5rem;\n}\n\n.text-center {\n  text-align: center;\n}\n\n/* View Transitions */\n@keyframes fadeIn {\n  from {\n    opacity: 0;\n  }\n  to {\n    opacity: 1;\n  }\n}\n\n.view-transition {\n  view-transition-name: view-transition;\n}\n\n::view-transition-old(view-transition) {\n  animation: 300ms cubic-bezier(0.4, 0, 0.2, 1) both fade-out;\n}\n\n::view-transition-new(view-transition) {\n  animation: 500ms cubic-bezier(0.4, 0, 0.2, 1) both fade-in;\n}\n\n@keyframes fade-out {\n  from {\n    opacity: 1;\n  }\n  to {\n    opacity: 0;\n  }\n}\n\n@keyframes fade-in {\n  from {\n    opacity: 0;\n  }\n  to {\n    opacity: 1;\n  }\n}\n\n/* PWA Install Banner */\n.install-banner {\n  background-color: var(--accent-color);\n  color: white;\n  padding: 1rem;\n  text-align: center;\n  position: fixed;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  z-index: 1000;\n  transform: translateY(100%);\n  transition: transform 0.3s ease;\n}\n\n.install-banner.show {\n  transform: translateY(0);\n}\n\n/* Mobile responsive design */\n@media screen and (max-width: 768px) {\n  .container {\n    padding: 0 0.5rem;\n  }\n\n  .app-header .container {\n    flex-direction: column;\n    gap: 0.5rem;\n  }\n\n  .main-nav ul {\n    flex-wrap: wrap;\n    justify-content: center;\n  }\n\n  .story-grid {\n    grid-template-columns: 1fr;\n  }\n\n  .form-grid {\n    grid-template-columns: 1fr;\n  }\n\n  .section-title {\n    font-size: 1.5rem;\n  }\n}\n\n/* Loading animation */\n#loading {\n  text-align: center;\n  padding: 2rem;\n}\n\n/* Offline indicator */\n.offline-indicator {\n  background-color: var(--error-color);\n  color: white;\n  padding: 0.5rem;\n  text-align: center;\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  z-index: 1001;\n  transform: translateY(-100%);\n  transition: transform 0.3s ease;\n}\n\n.offline-indicator.show {\n  transform: translateY(0);\n}\n',""]);const s=a},314:e=>{e.exports=function(e){var n=[];return n.toString=function(){return this.map((function(n){var t="",r=void 0!==n[5];return n[4]&&(t+="@supports (".concat(n[4],") {")),n[2]&&(t+="@media ".concat(n[2]," {")),r&&(t+="@layer".concat(n[5].length>0?" ".concat(n[5]):""," {")),t+=e(n),r&&(t+="}"),n[2]&&(t+="}"),n[4]&&(t+="}"),t})).join("")},n.i=function(e,t,r,i,o){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(r)for(var s=0;s<this.length;s++){var l=this[s][0];null!=l&&(a[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);r&&a[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),t&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=t):d[2]=t),i&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=i):d[4]="".concat(i)),n.push(d))}},n}},540:e=>{e.exports=function(e){var n=document.createElement("style");return e.setAttributes(n,e.attributes),e.insert(n,e.options),n}},601:e=>{e.exports=function(e){return e[1]}},659:e=>{var n={};e.exports=function(e,t){var r=function(e){if(void 0===n[e]){var t=document.querySelector(e);if(window.HTMLIFrameElement&&t instanceof window.HTMLIFrameElement)try{t=t.contentDocument.head}catch(e){t=null}n[e]=t}return n[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(t)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var n=e.insertStyleElement(e);return{update:function(t){!function(e,n,t){var r="";t.supports&&(r+="@supports (".concat(t.supports,") {")),t.media&&(r+="@media ".concat(t.media," {"));var i=void 0!==t.layer;i&&(r+="@layer".concat(t.layer.length>0?" ".concat(t.layer):""," {")),r+=t.css,i&&(r+="}"),t.media&&(r+="}"),t.supports&&(r+="}");var o=t.sourceMap;o&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),n.styleTagTransform(r,e,n.options)}(n,e,t)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)}}}}},n={};function t(r){var i=n[r];if(void 0!==i)return i.exports;var o=n[r]={id:r,exports:{}};return e[r](o,o.exports,t),o.exports}t.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},t.d=(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},t.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),t.nc=void 0;var r=t(72),i=t.n(r),o=t(825),a=t.n(o),s=t(659),l=t.n(s),c=t(56),d=t.n(c),u=t(540),m=t.n(u),h=t(113),p=t.n(h),g=t(249),f={};f.styleTagTransform=p(),f.setAttributes=d(),f.insert=l().bind(null,"head"),f.domAPI=a(),f.insertStyleElement=m(),i()(g.A,f),g.A&&g.A.locals&&g.A.locals;const y=new class{constructor(){this.routes={},this.currentUrl="",window.addEventListener("hashchange",(()=>{this.navigate(window.location.hash)})),window.addEventListener("popstate",(()=>{this.navigate(window.location.hash)}))}addRoute(e,n){this.routes[e]=n}navigate(e){e&&""!==e||(e="#/");const n=e.replace("#","");if(n===this.currentUrl)return;this.currentUrl=n;const t=Object.keys(this.routes).find((e=>{if(e===n)return!0;if(e.includes(":")){const t=e.split("/"),r=n.split("/");return t.length===r.length&&t.every(((e,n)=>!!e.startsWith(":")||e===r[n]))}return!1}));if(t){const e={};if(t.includes(":")){const r=t.split("/"),i=n.split("/");r.forEach(((n,t)=>{n.startsWith(":")&&(e[n.slice(1)]=i[t])}))}document.startViewTransition?document.startViewTransition((()=>{this.routes[t](e),this._updatePageTitle(n)})):(this.routes[t](e),this._updatePageTitle(n)),setTimeout((()=>{const e=document.getElementById("main-content");e&&e.focus()}),100)}else this.navigate("#/404")}_updatePageTitle(e){document.title={"/":"Home - Dicoding Story","/add":"Tambah Cerita - Dicoding Story","/offline":"Cerita Offline - Dicoding Story","/login":"Login - Dicoding Story","/register":"Register - Dicoding Story","/404":"404 - Halaman Tidak Ditemukan"}[e]||"Dicoding Story App"}init(){this.navigate(window.location.hash)}},b=new class{constructor(){this.baseUrl="https://story-api.dicoding.dev/v1",this.token=localStorage.getItem("token")||null}async _fetchWithAuth(e,n={}){return fetch(e,{...n,headers:{...n.headers,Authorization:`Bearer ${this.token}`}})}async register(e,n,t){return(await fetch(`${this.baseUrl}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:n,password:t})})).json()}async login(e,n){const t=await fetch(`${this.baseUrl}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:n})}),r=await t.json();if(!t.ok)throw new Error(r.message||"Failed to login");if(r.loginResult&&r.loginResult.token){this.token=r.loginResult.token,localStorage.setItem("token",this.token);const e=document.getElementById("logoutContainer");e&&(e.style.display="block");const n=document.getElementById("notification-controls");n&&(n.style.display="block")}return r}async logout(){this.token=null,localStorage.removeItem("token");const e=document.getElementById("logoutContainer");e&&(e.style.display="none");const n=document.getElementById("notification-controls");n&&(n.style.display="none")}async getAllStories(){if(!this.token)throw new Error("Authentication required");return(await this._fetchWithAuth(`${this.baseUrl}/stories`)).json()}async getStoryDetail(e){if(!this.token)throw new Error("Authentication required");return(await this._fetchWithAuth(`${this.baseUrl}/stories/${e}`)).json()}async addNewStory(e,n,t,r){if(!this.token)throw new Error("Authentication required");const i=new FormData;return i.append("description",e),i.append("photo",n),t&&r&&(i.append("lat",t),i.append("lon",r)),(await this._fetchWithAuth(`${this.baseUrl}/stories`,{method:"POST",body:i})).json()}isAuthenticated(){return!!this.token}},v=new class{constructor(){this.appContainer=document.getElementById("app"),this.loadingElement=document.getElementById("loading")}showLoading(){this.loadingElement&&(this.loadingElement.style.display="block",this.loadingElement.setAttribute("aria-busy","true"))}hideLoading(){this.loadingElement&&(this.loadingElement.style.display="none",this.loadingElement.setAttribute("aria-busy","false"))}renderHTML(e){this.appContainer&&(this.appContainer.innerHTML=e)}showError(e){const n=`\n        <div class="alert alert-error" role="alert">\n          <i class="fas fa-exclamation-circle" aria-hidden="true"></i> ${e}\n        </div>\n      `;this.appContainer&&(this.appContainer.innerHTML=n+this.appContainer.innerHTML)}showSuccess(e){const n=`\n        <div class="alert alert-success" role="alert">\n          <i class="fas fa-check-circle" aria-hidden="true"></i> ${e}\n        </div>\n      `;this.appContainer&&(this.appContainer.innerHTML=n+this.appContainer.innerHTML)}},w=new class{render(e="404",n="Halaman Tidak Ditemukan",t="Maaf, halaman yang Anda cari tidak tersedia atau Anda tidak memiliki akses."){return`\n        <section class="error-section text-center">\n          <h2 class="section-title">${e} - ${n}</h2>\n          <p class="section-description">${t}</p>\n          <div style="margin: 2rem 0;">\n            <i class="fas fa-sad-tear fa-5x" style="color: var(--primary-color);"></i>\n          </div>\n          <div class="text-center" style="margin-top: 2rem;">\n            <a href="#/" class="btn">\n              <i class="fas fa-home" aria-hidden="true"></i> Kembali ke Beranda\n            </a>\n          </div>\n        </section>\n      `}},k=new class{constructor(){this.stories=[],this.map=null,this.markers=[]}render(e,n=!1){this.stories=e;const t=((e,n=!1)=>{const t=n?"Cerita Tersimpan Offline":"Cerita Terbaru",r=n?"Berikut adalah cerita yang telah Anda simpan untuk diakses secara offline.":"Berikut adalah cerita terbaru dari pengguna Dicoding Story";return 0===e.length&&n?`\n        <section class="stories-section">\n          <h2 class="section-title">${t}</h2>\n          <p class="section-description">${r}</p>\n          <div class="text-center" style="padding: 2rem;">\n            <i class="fas fa-database fa-3x" style="color: var(--dark-gray); margin-bottom: 1rem;"></i>\n            <p>Tidak ada cerita yang tersimpan secara offline.</p>\n            <a href="#/" class="btn">Kembali ke Beranda</a>\n          </div>\n        </section>\n      `:`\n      <section class="stories-section">\n        <h2 class="section-title">${t}</h2>\n        <p class="section-description">${r}</p>\n        \n        ${n?"":'<div class="map-container" id="storiesMap" role="application" aria-label="Peta lokasi cerita"></div>'}\n        \n        <div class="story-grid">\n          ${e.map((e=>((e,n=!1)=>{const t=e.lat||null,r=e.lon||null,i=null!==t&&null!==r,o=n?`<button class="btn btn-danger btn-delete-offline" data-id="${e.id}" aria-label="Hapus cerita offline ${e.name}">\n           <i class="fas fa-trash" aria-hidden="true"></i> Hapus\n         </button>`:`<button class="btn btn-save-offline" data-id="${e.id}" aria-label="Simpan cerita ${e.name} untuk offline">\n           <i class="fas fa-save" aria-hidden="true"></i> Simpan Offline\n         </button>`;return`\n      <article class="story-card">\n        <img \n          src="${e.photoUrl}" \n          alt="Cerita dari ${e.name}: ${e.description.substring(0,50)}${e.description.length>50?"...":""}" \n          class="story-image"\n        >\n        <div class="story-content">\n          <h2 class="story-title">${e.name}</h2>\n          <p class="story-description">${e.description}</p>\n          <div class="story-meta">\n            <span class="story-date">\n              <i class="fas fa-calendar" aria-hidden="true"></i> ${new Date(e.createdAt).toLocaleDateString("id-ID")}\n            </span>\n            <span class="story-location">\n              <i class="fas fa-map-marker-alt" aria-hidden="true"></i> \n              ${i?"Lihat lokasi":"Lokasi tidak tersedia"}\n            </span>\n          </div>\n          <div style="margin-top: 10px;">\n            ${o}\n          </div>\n        </div>\n      </article>\n    `})(e,n))).join("")}\n        </div>\n      </section>\n    `})(e,n);v.renderHTML(t),n||this.initMap()}initMap(){const e=document.getElementById("storiesMap");if(!e)return;this.map=L.map(e).setView([-2.548926,118.0148634],5),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19}).addTo(this.map);const n={OpenStreetMap:L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19}),Satellite:L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri",maxZoom:19}),Topography:L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{attribution:'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:17})};L.control.layers(n).addTo(this.map),this.addMarkers()}addMarkers(){if(this.map&&(this.markers.forEach((e=>this.map.removeLayer(e))),this.markers=[],this.stories.forEach((e=>{if(e.lat&&e.lon){const n=L.marker([e.lat,e.lon]).addTo(this.map).bindPopup(`\n            <div class="map-popup">\n              <strong>${e.name}</strong>\n              <p>${e.description.substring(0,100)}${e.description.length>100?"...":""}</p>\n              <img src="${e.photoUrl}" alt="Thumbnail cerita ${e.name}" style="width: 100%; max-height: 100px; object-fit: cover; border-radius: 4px; margin-top: 5px;">\n            </div>\n          `);this.markers.push(n)}})),this.markers.length>0)){const e=new L.featureGroup(this.markers);this.map.fitBounds(e.getBounds().pad(.2))}}},E=new class{constructor(){this.stories=[],this.currentStory=null}async fetchAllStories(){try{const e=await b.getAllStories();if(e.error)throw new Error(e.message);return this.stories=e.listStory||[],this.stories}catch(e){throw console.error("Error fetching stories:",e),e}}async fetchStoryDetail(e){try{const n=await b.getStoryDetail(e);if(n.error)throw new Error(n.message);return this.currentStory=n.story,this.currentStory}catch(n){throw console.error(`Error fetching story with id ${e}:`,n),n}}async addStory(e,n,t,r){try{const i=await b.addNewStory(e,n,t,r);if(i.error)throw new Error(i.message);return i}catch(e){throw console.error("Error adding new story:",e),e}}getStories(){return this.stories}getCurrentStory(){return this.currentStory}clearStories(){this.stories=[],this.currentStory=null}},S="stories";let x;const I=()=>(x||(x=new Promise(((e,n)=>{const t=indexedDB.open("dicoding-story-app-db",1);t.onerror=()=>{n(new Error("Failed to open database"))},t.onsuccess=()=>{e(t.result)},t.onupgradeneeded=e=>{const n=e.target.result;if(!n.objectStoreNames.contains(S)){const e=n.createObjectStore(S,{keyPath:"id"});e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("name","name",{unique:!1})}}}))),x),P={async getAllStories(){try{const e=(await I()).transaction([S],"readonly").objectStore(S);return new Promise(((n,t)=>{const r=e.getAll();r.onsuccess=()=>n(r.result||[]),r.onerror=()=>t(new Error("Failed to get stories"))}))}catch(e){return console.error("Error getting all stories:",e),[]}},async getStoryById(e){try{const n=(await I()).transaction([S],"readonly").objectStore(S);return new Promise(((t,r)=>{const i=n.get(e);i.onsuccess=()=>t(i.result),i.onerror=()=>r(new Error("Failed to get story"))}))}catch(e){return console.error("Error getting story by id:",e),null}},async putStory(e){if(!e||!e.id)return console.error("Story object must have an id property."),null;try{const n=(await I()).transaction([S],"readwrite").objectStore(S);return new Promise(((t,r)=>{const i=n.put(e);i.onsuccess=()=>t(i.result),i.onerror=()=>r(new Error("Failed to put story"))}))}catch(e){throw console.error("Error putting story:",e),e}},async putAllStories(e){if(e&&Array.isArray(e))try{const n=(await I()).transaction([S],"readwrite").objectStore(S),t=e.map((e=>e&&e.id?new Promise(((t,r)=>{const i=n.put(e);i.onsuccess=()=>t(i.result),i.onerror=()=>r(new Error("Failed to put story"))})):Promise.resolve()));await Promise.all(t),console.log(`Successfully saved ${e.length} stories to IndexedDB`)}catch(e){throw console.error("Error putting all stories:",e),e}else console.error("Input must be an array of stories.")},async deleteStory(e){try{const n=(await I()).transaction([S],"readwrite").objectStore(S);return new Promise(((t,r)=>{const i=n.delete(e);i.onsuccess=()=>t(i.result),i.onerror=()=>r(new Error("Failed to delete story"))}))}catch(e){throw console.error("Error deleting story:",e),e}},async clearAllStories(){try{const e=(await I()).transaction([S],"readwrite").objectStore(S);return new Promise(((n,t)=>{const r=e.clear();r.onsuccess=()=>{console.log("All stories cleared from IndexedDB."),n(r.result)},r.onerror=()=>t(new Error("Failed to clear stories"))}))}catch(e){throw console.error("Error clearing all stories:",e),e}}},B=class{constructor(){this._view=k,this._model=E,this._dbHelper=P,this.init()}async init(){v.showLoading();try{if(!b.isAuthenticated())return void y.navigate("#/login");const e=document.getElementById("logoutContainer");e&&(e.style.display="block");const n=document.getElementById("notification-controls");n&&(n.style.display="block");const t=await this._model.fetchAllStories();t&&t.length>0&&(await this._dbHelper.putAllStories(t),console.log("Stories saved to IndexedDB for offline access")),this._view.render(t),this._setupSaveOfflineListeners(t)}catch(e){console.error("Error initializing list presenter:",e),v.showError("Terjadi kesalahan saat memuat cerita. Menampilkan data offline jika ada...");try{const e=await this._dbHelper.getAllStories();e&&e.length>0?(this._view.render(e),v.showSuccess("Menampilkan cerita dari cache offline."),this._setupSaveOfflineListeners(e)):v.showError("Tidak ada cerita di cache offline.")}catch(e){console.error("Error fetching stories from DB:",e),v.showError("Gagal memuat cerita dari API maupun cache offline.")}}finally{v.hideLoading()}}_setupSaveOfflineListeners(e){document.querySelectorAll(".btn-save-offline").forEach((n=>{n.addEventListener("click",(async n=>{const t=n.target.closest("button").dataset.id,r=e.find((e=>e.id===t));if(r)try{await this._dbHelper.putStory(r),v.showSuccess(`Cerita "${r.name}" berhasil disimpan offline!`);const e=n.target.closest("button");e.innerHTML='<i class="fas fa-check" aria-hidden="true"></i> Tersimpan',e.disabled=!0,e.classList.remove("btn-save-offline"),e.classList.add("btn-success")}catch(e){console.error("Gagal menyimpan cerita offline:",e),v.showError("Gagal menyimpan cerita offline.")}}))}))}destroy(){}},C=new class{constructor(){this.stream=null,this.videoElement=null,this.canvasElement=null,this.facingMode="environment"}async startCamera(e,n){this.videoElement=e,this.canvasElement=n;try{return this.stopCamera(),this.videoElement.setAttribute("aria-label","Pratinjau kamera"),this.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:this.facingMode},audio:!1}),this._announceToScreenReader("Kamera aktif, siap mengambil foto"),this.videoElement.srcObject=this.stream,await this.videoElement.play(),!0}catch(e){return console.error("Error starting camera:",e),this._announceToScreenReader("Kamera tidak dapat diakses"),!1}}stopCamera(){this.stream&&(this.stream.getTracks().forEach((e=>e.stop())),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null)}switchCamera(){this.facingMode="environment"===this.facingMode?"user":"environment",this.videoElement&&(this.startCamera(this.videoElement,this.canvasElement),this._announceToScreenReader("Beralih ke kamera "+("environment"===this.facingMode?"belakang":"depan")))}takePhoto(){if(!this.videoElement||!this.canvasElement)return null;const e=this.canvasElement.getContext("2d");return this.canvasElement.width=this.videoElement.videoWidth,this.canvasElement.height=this.videoElement.videoHeight,e.drawImage(this.videoElement,0,0,this.canvasElement.width,this.canvasElement.height),this._announceToScreenReader("Foto berhasil diambil"),this.dataURLtoBlob(this.canvasElement.toDataURL("image/jpeg"))}dataURLtoBlob(e){const n=e.split(";base64,"),t=n[0].split(":")[1],r=window.atob(n[1]),i=new Uint8Array(r.length);for(let e=0;e<r.length;++e)i[e]=r.charCodeAt(e);return new Blob([i],{type:t})}_announceToScreenReader(e){const n=document.createElement("div");n.setAttribute("aria-live","polite"),n.classList.add("sr-only"),n.textContent=e,document.body.appendChild(n),setTimeout((()=>{document.body.contains(n)&&document.body.removeChild(n)}),1e3)}},A=new class{constructor(){this.map=null,this.marker=null,this.photoBlob=null,this.latitude=null,this.longitude=null}render(){v.renderHTML('\n      <section class="add-story-section">\n        <h2 class="section-title">Tambah Cerita Baru</h2>\n        <p class="section-description">Bagikan pengalaman menarikmu melalui cerita dengan gambar</p>\n        \n        <form id="addStoryForm" class="form-grid" aria-labelledby="form-title">\n          <h3 id="form-title" class="sr-only">Form Tambah Cerita</h3>\n          \n          <div class="form-column">\n            <div class="form-group">\n              <label for="description" class="form-label">Deskripsi</label>\n              <textarea \n                id="description" \n                name="description"\n                class="form-control" \n                placeholder="Ceritakan pengalamanmu..." \n                required\n                aria-required="true"\n                aria-describedby="description-help"\n              ></textarea>\n              <small id="description-help" class="form-text">Tulis cerita dengan jelas dan menarik.</small>\n            </div>\n            \n            <div class="form-group">\n              <label id="location-label" class="form-label">Lokasi</label>\n              <div class="map-container" id="locationMap" aria-labelledby="location-label" role="application"></div>\n              <small id="map-help" class="form-text">Klik pada peta untuk memilih lokasi.</small>\n            </div>\n            \n            <div class="form-group">\n              <input type="hidden" id="latitude" name="latitude">\n              <input type="hidden" id="longitude" name="longitude">\n              <p id="selectedLocation" aria-live="polite">Belum memilih lokasi</p>\n            </div>\n          </div>\n          \n          <div class="form-column">\n            <div class="form-group">\n              <label id="photo-label" class="form-label">Foto Cerita</label>\n              <div class="camera-container" aria-labelledby="photo-label">\n                <video id="cameraPreview" class="camera-preview" autoplay playsinline aria-label="Pratinjau kamera"></video>\n                <canvas id="photoCanvas" style="display: none;"></canvas>\n                <div class="camera-controls">\n                  <button type="button" id="switchCameraBtn" class="camera-btn" aria-label="Ganti kamera">\n                    <i class="fas fa-sync-alt" aria-hidden="true"></i>\n                  </button>\n                  <button type="button" id="capturePhotoBtn" class="camera-btn" aria-label="Ambil foto">\n                    <i class="fas fa-camera" aria-hidden="true"></i>\n                  </button>\n                </div>\n              </div>\n              <small id="camera-help" class="form-text">Ambil foto menggunakan kamera atau pilih dari perangkatmu.</small>\n            </div>\n            \n            <div class="form-group">\n              <label for="photoFile" class="form-label">Atau upload file gambar</label>\n              <input \n                type="file" \n                id="photoFile" \n                name="photoFile"\n                class="form-control" \n                accept="image/*"\n                aria-describedby="file-help"\n              >\n              <small id="file-help" class="form-text">Format yang didukung: JPG, PNG, GIF.</small>\n            </div>\n            \n            <div class="form-group">\n              <img id="photoPreview" style="display: none; max-width: 100%; border-radius: var(--border-radius); margin-top: 1rem;" alt="Pratinjau foto yang dipilih">\n            </div>\n            \n            <div class="form-group">\n              <button type="submit" class="btn btn-block">\n                <i class="fas fa-paper-plane" aria-hidden="true"></i> Kirim Cerita\n              </button>\n            </div>\n          </div>\n        </form>\n      </section>\n    '),this.initializeCamera(),this.initializeMap(),this.setupEventListeners()}async initializeCamera(){const e=document.getElementById("cameraPreview"),n=document.getElementById("photoCanvas");if(e&&n)try{await C.startCamera(e,n)}catch(n){console.error("Failed to initialize camera:",n);const t=e.closest(".camera-container");t&&(t.innerHTML='\n          <div class="camera-error" role="alert">\n            <p><i class="fas fa-exclamation-triangle"></i> Kamera tidak dapat diakses. Silakan gunakan opsi upload file.</p>\n          </div>\n        ')}}initializeMap(){const e=document.getElementById("locationMap");e&&(this.map=L.map(e).setView([-2.548926,118.0148634],5),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19}).addTo(this.map),this.map.on("click",(e=>{this.setLocationMarker(e.latlng.lat,e.latlng.lng)})))}setLocationMarker(e,n){this.latitude=e,this.longitude=n;const t=document.getElementById("latitude"),r=document.getElementById("longitude"),i=document.getElementById("selectedLocation");t&&(t.value=e),r&&(r.value=n),i&&(i.textContent=`Lokasi terpilih: ${e.toFixed(6)}, ${n.toFixed(6)}`),this.marker?this.marker.setLatLng([e,n]):this.marker=L.marker([e,n]).addTo(this.map),this.map.setView([e,n],14)}setupEventListeners(){const e=document.getElementById("capturePhotoBtn");e&&e.addEventListener("click",(()=>{if(this.photoBlob=C.takePhoto(),this.photoBlob){const e=document.getElementById("photoPreview");e&&(e.src=URL.createObjectURL(this.photoBlob),e.alt="Pratinjau foto yang akan diunggah",e.style.display="block")}}));const n=document.getElementById("switchCameraBtn");n&&n.addEventListener("click",(()=>{C.switchCamera()}));const t=document.getElementById("photoFile");t&&t.addEventListener("change",(e=>{if(e.target.files&&e.target.files[0]){this.photoBlob=e.target.files[0];const n=document.getElementById("photoPreview");n&&(n.src=URL.createObjectURL(this.photoBlob),n.alt="Pratinjau foto yang dipilih",n.style.display="block")}}));const r=document.getElementById("addStoryForm");r&&r.addEventListener("submit",(e=>{e.preventDefault();const n=document.getElementById("description"),t=n?n.value:"";this.onSubmit&&this.onSubmit({description:t,photo:this.photoBlob,latitude:this.latitude,longitude:this.longitude})}))}setSubmitCallback(e){this.onSubmit=e}cleanup(){C.stopCamera(),this.photoBlob&&URL.revokeObjectURL(this.photoBlob)}},M=class{constructor(){this._view=A,this._model=E,this.init()}async init(){if(!b.isAuthenticated())return void y.navigate("#/login");const e=document.getElementById("logoutContainer");e&&(e.style.display="block");const n=document.getElementById("notification-controls");n&&(n.style.display="block"),this._view.render(),this._view.setSubmitCallback(this.handleSubmit.bind(this))}async handleSubmit(e){v.showLoading();try{const{description:n,photo:t,latitude:r,longitude:i}=e;if(!n)throw new Error("Deskripsi cerita tidak boleh kosong");if(!t)throw new Error("Foto cerita tidak boleh kosong");await this._model.addStory(n,t,r,i),v.showSuccess("Cerita berhasil ditambahkan!"),setTimeout((()=>{y.navigate("#/")}),1500)}catch(e){console.error("Error submitting form:",e),v.showError(e.message||"Terjadi kesalahan saat menambahkan cerita.")}finally{v.hideLoading()}}destroy(){this._view.cleanup()}},T=class{constructor(){this._view=k,this._dbHelper=P,this.init()}async init(){v.showLoading();try{if(b.isAuthenticated()){const e=document.getElementById("logoutContainer");e&&(e.style.display="block");const n=document.getElementById("notification-controls");n&&(n.style.display="block")}const e=await this._dbHelper.getAllStories();this._view.render(e,!0),this._setupDeleteOfflineListeners()}catch(e){console.error("Error initializing offline list presenter:",e),v.showError("Gagal memuat cerita offline.")}finally{v.hideLoading()}}_setupDeleteOfflineListeners(){document.querySelectorAll(".btn-delete-offline").forEach((e=>{e.addEventListener("click",(async e=>{const n=e.target.closest("button").dataset.id;if(confirm("Apakah Anda yakin ingin menghapus cerita ini dari daftar offline?"))try{await this._dbHelper.deleteStory(n),v.showSuccess("Cerita berhasil dihapus dari daftar offline!"),setTimeout((()=>{this.init()}),1e3)}catch(e){console.error("Gagal menghapus cerita offline:",e),v.showError("Gagal menghapus cerita offline.")}}))}))}destroy(){}},j=new class{constructor(){this.onSubmit=null}render(){return'\n        <section class="login-section">\n          <h2 class="section-title">Login ke Dicoding Story</h2>\n          <p class="section-description">Masukkan email dan password untuk melanjutkan</p>\n          \n          <form id="loginForm" class="form" aria-labelledby="login-title">\n            <h3 id="login-title" class="sr-only">Form Login</h3>\n            \n            <div class="form-group">\n              <label for="loginEmail" class="form-label">Email</label>\n              <input \n                type="email" \n                id="loginEmail" \n                name="email"\n                class="form-control" \n                placeholder="Alamat email" \n                required\n                aria-required="true"\n              >\n            </div>\n            \n            <div class="form-group">\n              <label for="loginPassword" class="form-label">Password</label>\n              <input \n                type="password" \n                id="loginPassword" \n                name="password"\n                class="form-control" \n                placeholder="Password" \n                required\n                aria-required="true"\n              >\n            </div>\n            \n            <div class="form-group">\n              <button type="submit" class="btn btn-block">\n                <i class="fas fa-sign-in-alt" aria-hidden="true"></i> Login\n              </button>\n            </div>\n            \n            <p class="text-center">\n              Belum punya akun? <a href="#/register">Daftar sekarang</a>\n            </p>\n          </form>\n        </section>\n      '}setupEventListeners(){const e=document.getElementById("loginForm");e&&this.onSubmit&&e.addEventListener("submit",(e=>{e.preventDefault();const n=document.getElementById("loginEmail").value,t=document.getElementById("loginPassword").value;this.onSubmit({email:n,password:t})}))}setSubmitCallback(e){this.onSubmit=e}showError(e){const n=document.getElementById("loginForm");if(n){const t=n.querySelector(".login-error");t&&t.remove();const r=document.createElement("div");r.className="alert alert-error login-error",r.innerHTML=`<i class="fas fa-exclamation-circle" aria-hidden="true"></i> ${e}`,n.insertBefore(r,n.firstChild)}}},D=class{constructor(){this._view=j,this.init()}init(){this._hideAuthenticatedElements();const e=this._view.render();v.renderHTML(e),this._view.setSubmitCallback(this.handleLogin.bind(this)),this._view.setupEventListeners()}async handleLogin(e){try{v.showLoading();const{email:n,password:t}=e;await b.login(n,t),y.navigate("#/")}catch(e){console.error("Login error:",e),this._view.showError(e.message||"Gagal login. Periksa email dan password.")}finally{v.hideLoading()}}_hideAuthenticatedElements(){const e=document.getElementById("logoutContainer");e&&(e.style.display="none");const n=document.getElementById("notification-controls");n&&(n.style.display="none")}destroy(){}},W=new class{constructor(){this.onSubmit=null}render(){return'\n        <section class="register-section">\n          <h2 class="section-title">Daftar Akun Baru</h2>\n          <p class="section-description">Buat akun untuk mulai berbagi cerita</p>\n          \n          <form id="registerForm" class="form" aria-labelledby="register-title">\n            <h3 id="register-title" class="sr-only">Form Registrasi</h3>\n            \n            <div class="form-group">\n              <label for="registerName" class="form-label">Nama</label>\n              <input \n                type="text" \n                id="registerName" \n                name="name"\n                class="form-control" \n                placeholder="Nama lengkap" \n                required\n                aria-required="true"\n              >\n            </div>\n            \n            <div class="form-group">\n              <label for="registerEmail" class="form-label">Email</label>\n              <input \n                type="email" \n                id="registerEmail" \n                name="email"\n                class="form-control" \n                placeholder="Alamat email" \n                required\n                aria-required="true"\n              >\n            </div>\n            \n            <div class="form-group">\n              <label for="registerPassword" class="form-label">Password</label>\n              <input \n                type="password" \n                id="registerPassword" \n                name="password"\n                class="form-control" \n                placeholder="Password (minimal 8 karakter)" \n                required\n                aria-required="true"\n                minlength="8"\n              >\n            </div>\n            \n            <div class="form-group">\n              <button type="submit" class="btn btn-block">\n                <i class="fas fa-user-plus" aria-hidden="true"></i> Daftar\n              </button>\n            </div>\n            \n            <p class="text-center">\n              Sudah punya akun? <a href="#/login">Login</a>\n            </p>\n          </form>\n        </section>\n      '}setupEventListeners(){const e=document.getElementById("registerForm");e&&this.onSubmit&&e.addEventListener("submit",(e=>{e.preventDefault();const n=document.getElementById("registerName").value,t=document.getElementById("registerEmail").value,r=document.getElementById("registerPassword").value;this.onSubmit({name:n,email:t,password:r})}))}setSubmitCallback(e){this.onSubmit=e}showError(e){const n=document.getElementById("registerForm");if(n){const t=n.querySelector(".register-error");t&&t.remove();const r=document.createElement("div");r.className="alert alert-error register-error",r.innerHTML=`<i class="fas fa-exclamation-circle" aria-hidden="true"></i> ${e}`,n.insertBefore(r,n.firstChild)}}showSuccess(e){const n=document.getElementById("registerForm");if(n){const t=n.querySelector(".register-success");t&&t.remove();const r=document.createElement("div");r.className="alert alert-success register-success",r.innerHTML=`<i class="fas fa-check-circle" aria-hidden="true"></i> ${e}`,n.insertBefore(r,n.firstChild)}}},H=class{constructor(){this._view=W,this.init()}init(){this._hideAuthenticatedElements();const e=this._view.render();v.renderHTML(e),this._view.setSubmitCallback(this.handleRegister.bind(this)),this._view.setupEventListeners()}async handleRegister(e){try{v.showLoading();const{name:n,email:t,password:r}=e,i=await b.register(n,t,r);if(i.error)throw new Error(i.message);this._view.showSuccess("Registrasi berhasil! Silakan login."),setTimeout((()=>{y.navigate("#/login")}),1500)}catch(e){console.error("Registration error:",e),this._view.showError(e.message||"Gagal mendaftar. Silakan coba lagi.")}finally{v.hideLoading()}}_hideAuthenticatedElements(){const e=document.getElementById("logoutContainer");e&&(e.style.display="none");const n=document.getElementById("notification-controls");n&&(n.style.display="none")}destroy(){}},R=new class{constructor(){this.currentPresenter=null,this.setupRoutes()}setupRoutes(){y.addRoute("/",(()=>{this._destroyCurrentPresenter(),this.currentPresenter=new B})),y.addRoute("/add",(()=>{this._destroyCurrentPresenter(),this.currentPresenter=new M})),y.addRoute("/offline",(()=>{this._destroyCurrentPresenter(),this.currentPresenter=new T})),y.addRoute("/login",(()=>{this._destroyCurrentPresenter(),this.currentPresenter=new D})),y.addRoute("/register",(()=>{this._destroyCurrentPresenter(),this.currentPresenter=new H})),y.addRoute("/404",(()=>{this._destroyCurrentPresenter();const e=w.render("404","Halaman Tidak Ditemukan","Maaf, halaman yang Anda cari tidak tersedia atau Anda tidak memiliki akses.");v.renderHTML(e)}))}_destroyCurrentPresenter(){this.currentPresenter&&"function"==typeof this.currentPresenter.destroy&&this.currentPresenter.destroy(),this.currentPresenter=null}init(){if(b.isAuthenticated()){const e=document.getElementById("logoutContainer");e&&(e.style.display="block");const n=document.getElementById("notification-controls");n&&(n.style.display="block"),y.init()}else y.navigate("#/login")}},z={async requestPermission(){if(!("Notification"in window))return console.error("This browser does not support notifications."),!1;try{const e=await Notification.requestPermission();return console.log("Notification permission:",e),"granted"===e}catch(e){return console.error("Error requesting notification permission:",e),!1}},async subscribePush(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return console.error("Push messaging is not supported."),null;try{console.log("Waiting for service worker to be ready...");const e=await navigator.serviceWorker.ready;console.log("Service worker is ready:",e);const n=await e.pushManager.getSubscription();if(n)return console.log("User is already subscribed:",n),n;console.log("Converting VAPID key...");const t=function(e){const n=(e+"=".repeat(1)).replace(/-/g,"+").replace(/_/g,"/");try{const e=window.atob(n),t=new Uint8Array(e.length);for(let n=0;n<e.length;++n)t[n]=e.charCodeAt(n);return t}catch(e){throw console.error("Error converting VAPID key:",e),new Error("Invalid VAPID key format")}}("BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk");console.log("VAPID key converted successfully"),console.log("Subscribing to push manager...");const r=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t});return console.log("User subscribed successfully:",r),localStorage.setItem("pushSubscription",JSON.stringify(r)),console.log("Subscription saved locally (development mode)"),r}catch(e){return console.error("Failed to subscribe the user:",e),null}},async unsubscribePush(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return console.error("Push messaging is not supported."),!1;try{const e=await navigator.serviceWorker.ready,n=await e.pushManager.getSubscription();if(!n)return console.log("User not subscribed."),!0;const t=await n.unsubscribe();return t?(console.log("User unsubscribed successfully."),localStorage.removeItem("pushSubscription")):console.error("Failed to unsubscribe user."),t}catch(e){return console.error("Error unsubscribing user:",e),!1}},async checkSubscription(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return!1;try{const e=await navigator.serviceWorker.ready;return!!await e.pushManager.getSubscription()}catch(e){return console.error("Error checking subscription:",e),!1}},async sendTestNotification(){if("serviceWorker"in navigator&&"PushManager"in window)try{const e=await navigator.serviceWorker.ready,n={title:"Test Notification - Dicoding Story",body:"Push notification berhasil berjalan di development!",icon:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIGZpbGw9IiMzNDk4ZGIiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjQ4IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkRTPC90ZXh0Pjwvc3ZnPg==",badge:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHZpZXdCb3g9IjAgMCA3MiA3MiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIGZpbGw9IiMyOTgwYjkiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE4IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkRTPC90ZXh0Pjwvc3ZnPg==",data:{url:"/"},requireInteraction:!0,tag:"dicoding-story-test"};await e.showNotification(n.title,{body:n.body,icon:n.icon,badge:n.badge,data:n.data,requireInteraction:n.requireInteraction,tag:n.tag}),console.log("Test notification sent successfully")}catch(e){console.error("Error sending test notification:",e)}}},U=z;try{self["workbox:window:6.5.4"]&&_()}catch($){}function $(e,n){return new Promise((function(t){var r=new MessageChannel;r.port1.onmessage=function(e){t(e.data)},e.postMessage(n,[r.port2])}))}function F(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function N(e,n){var t;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(t=function(e,n){if(e){if("string"==typeof e)return F(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?F(e,n):void 0}}(e))||n&&e&&"number"==typeof e.length){t&&(e=t);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(t=e[Symbol.iterator]()).next.bind(t)}try{self["workbox:core:6.5.4"]&&_()}catch($){}var O=function(){var e=this;this.promise=new Promise((function(n,t){e.resolve=n,e.reject=t}))};function G(e,n){var t=location.href;return new URL(e,t).href===new URL(n,t).href}var Z=function(e,n){this.type=e,Object.assign(this,n)};function q(e,n,t){return t?n?n(e):e:(e&&e.then||(e=Promise.resolve(e)),n?e.then(n):e)}function V(){}var J={type:"SKIP_WAITING"};function K(e,n){if(!n)return e&&e.then?e.then(V):Promise.resolve()}var Y=function(e){var n,t;function r(n,t){var r,i;return void 0===t&&(t={}),(r=e.call(this)||this).nn={},r.tn=0,r.rn=new O,r.en=new O,r.on=new O,r.un=0,r.an=new Set,r.cn=function(){var e=r.fn,n=e.installing;r.tn>0||!G(n.scriptURL,r.sn.toString())||performance.now()>r.un+6e4?(r.vn=n,e.removeEventListener("updatefound",r.cn)):(r.hn=n,r.an.add(n),r.rn.resolve(n)),++r.tn,n.addEventListener("statechange",r.ln)},r.ln=function(e){var n=r.fn,t=e.target,i=t.state,o=t===r.vn,a={sw:t,isExternal:o,originalEvent:e};!o&&r.mn&&(a.isUpdate=!0),r.dispatchEvent(new Z(i,a)),"installed"===i?r.wn=self.setTimeout((function(){"installed"===i&&n.waiting===t&&r.dispatchEvent(new Z("waiting",a))}),200):"activating"===i&&(clearTimeout(r.wn),o||r.en.resolve(t))},r.dn=function(e){var n=r.hn,t=n!==navigator.serviceWorker.controller;r.dispatchEvent(new Z("controlling",{isExternal:t,originalEvent:e,sw:n,isUpdate:r.mn})),t||r.on.resolve(n)},r.gn=(i=function(e){var n=e.data,t=e.ports,i=e.source;return q(r.getSW(),(function(){r.an.has(i)&&r.dispatchEvent(new Z("message",{data:n,originalEvent:e,ports:t,sw:i}))}))},function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];try{return Promise.resolve(i.apply(this,e))}catch(e){return Promise.reject(e)}}),r.sn=n,r.nn=t,navigator.serviceWorker.addEventListener("message",r.gn),r}t=e,(n=r).prototype=Object.create(t.prototype),n.prototype.constructor=n,n.__proto__=t;var i,o=r.prototype;return o.register=function(e){var n=(void 0===e?{}:e).immediate,t=void 0!==n&&n;try{var r=this;return function(e,n){var t=e();return t&&t.then?t.then(n):n()}((function(){if(!t&&"complete"!==document.readyState)return K(new Promise((function(e){return window.addEventListener("load",e)})))}),(function(){return r.mn=Boolean(navigator.serviceWorker.controller),r.yn=r.pn(),q(r.bn(),(function(e){r.fn=e,r.yn&&(r.hn=r.yn,r.en.resolve(r.yn),r.on.resolve(r.yn),r.yn.addEventListener("statechange",r.ln,{once:!0}));var n=r.fn.waiting;return n&&G(n.scriptURL,r.sn.toString())&&(r.hn=n,Promise.resolve().then((function(){r.dispatchEvent(new Z("waiting",{sw:n,wasWaitingBeforeRegister:!0}))})).then((function(){}))),r.hn&&(r.rn.resolve(r.hn),r.an.add(r.hn)),r.fn.addEventListener("updatefound",r.cn),navigator.serviceWorker.addEventListener("controllerchange",r.dn),r.fn}))}))}catch(e){return Promise.reject(e)}},o.update=function(){try{return this.fn?K(this.fn.update()):void 0}catch(e){return Promise.reject(e)}},o.getSW=function(){return void 0!==this.hn?Promise.resolve(this.hn):this.rn.promise},o.messageSW=function(e){try{return q(this.getSW(),(function(n){return $(n,e)}))}catch(e){return Promise.reject(e)}},o.messageSkipWaiting=function(){this.fn&&this.fn.waiting&&$(this.fn.waiting,J)},o.pn=function(){var e=navigator.serviceWorker.controller;return e&&G(e.scriptURL,this.sn.toString())?e:void 0},o.bn=function(){try{var e=this;return function(e,n){try{var t=e()}catch(e){return n(e)}return t&&t.then?t.then(void 0,n):t}((function(){return q(navigator.serviceWorker.register(e.sn,e.nn),(function(n){return e.un=performance.now(),n}))}),(function(e){throw e}))}catch(e){return Promise.reject(e)}},(i=[{key:"active",get:function(){return this.en.promise}},{key:"controlling",get:function(){return this.on.promise}}])&&function(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(r.prototype,i),r}(function(){function e(){this.Pn=new Map}var n=e.prototype;return n.addEventListener=function(e,n){this.Sn(e).add(n)},n.removeEventListener=function(e,n){this.Sn(e).delete(n)},n.dispatchEvent=function(e){e.target=this;for(var n,t=N(this.Sn(e.type));!(n=t()).done;)(0,n.value)(e)},n.Sn=function(e){return this.Pn.has(e)||this.Pn.set(e,new Set),this.Pn.get(e)},e}());document.addEventListener("DOMContentLoaded",(async()=>{await(async()=>{if(!("serviceWorker"in navigator))return console.log("Service Worker not supported in this browser."),null;try{const e=new Y("/sw.js");return e.addEventListener("installed",(e=>{e.isUpdate?console.log("Service Worker updated"):console.log("Service Worker installed for the first time")})),e.addEventListener("controlling",(()=>{console.log("Service Worker is controlling the page")})),await e.register(),console.log("Service Worker registered successfully"),e}catch(e){return console.error("Service Worker registration failed:",e),null}})(),(()=>{let e;window.addEventListener("beforeinstallprompt",(n=>{n.preventDefault(),e=n;const t=document.createElement("div");t.className="install-banner",t.innerHTML='\n      <p><i class="fas fa-download"></i> Install aplikasi ini untuk pengalaman yang lebih baik!</p>\n      <button id="installBtn" class="btn" style="margin-left: 1rem;">Install</button>\n      <button id="dismissBtn" class="btn" style="margin-left: 0.5rem; background: transparent; border: 1px solid white;">Nanti</button>\n    ',document.body.appendChild(t),setTimeout((()=>t.classList.add("show")),100),document.getElementById("installBtn").addEventListener("click",(async()=>{e.prompt();const{outcome:n}=await e.userChoice;console.log(`User response to the install prompt: ${n}`),e=null,t.remove()})),document.getElementById("dismissBtn").addEventListener("click",(()=>{t.remove()}))}))})(),(()=>{const e=document.createElement("div");e.className="offline-indicator",e.innerHTML='<i class="fas fa-wifi"></i> Anda sedang offline',document.body.appendChild(e),window.addEventListener("online",(()=>{e.classList.remove("show")})),window.addEventListener("offline",(()=>{e.classList.add("show")}))})(),R.init(),(()=>{const e=document.getElementById("logoutButton");e&&e.addEventListener("click",(async()=>{try{await b.logout(),await P.clearAllStories(),console.log("Offline stories cleared after logout."),window.location.hash="#/login"}catch(e){console.error("Logout error:",e)}}))})(),(()=>{const e=document.querySelector(".skip-link");e&&e.addEventListener("click",(e=>{e.preventDefault();const n=document.getElementById("main-content");n&&(n.focus(),n.scrollIntoView({behavior:"smooth"}))}))})(),b.isAuthenticated()&&await(async()=>{const e=document.getElementById("subscribePushBtn"),n=document.getElementById("unsubscribePushBtn");e&&n&&(await U.checkSubscription()?(e.style.display="none",n.style.display="inline-block"):(e.style.display="inline-block",n.style.display="none"),e.addEventListener("click",(async()=>{await U.requestPermission()?await U.subscribePush()?(console.log("Successfully subscribed to push notifications."),e.style.display="none",n.style.display="inline-block",setTimeout((()=>{U.sendTestNotification()}),2e3),alert("Anda berhasil subscribe notifikasi! Notifikasi test akan muncul dalam 2 detik.")):alert("Gagal subscribe notifikasi. Cek konsol untuk detail."):alert("Izin notifikasi tidak diberikan.")})),n.addEventListener("click",(async()=>{await U.unsubscribePush()?(console.log("Successfully unsubscribed from push notifications."),e.style.display="inline-block",n.style.display="none",alert("Anda berhasil unsubscribe notifikasi!")):alert("Gagal unsubscribe notifikasi. Cek konsol untuk detail.")})))})()}))})();